<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-audio-font@1.0.3/dist/WebAudioFontPlayer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/midi-parser-js@3.0.0/dist/midi-parser.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            width: 320px;
            height: auto;
        }
        .btn {
            @apply px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed;
        }
        .emoji-btn {
            @apply text-2xl px-2 py-1;
        }
        /* Custom styling for the progress bar (O------------) */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #4B5563; /* Tailwind gray-600 */
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 9999px; /* Tailwind rounded-full */
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #20C2A0; /* Tailwind teal-400 */
            cursor: pointer;
            border-radius: 9999px; /* Tailwind rounded-full */
            border: 2px solid #fff;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #20C2A0; /* Tailwind teal-400 */
            cursor: pointer;
            border-radius: 9999px; /* Tailwind rounded-full */
            border: 2px solid #fff;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4">
    <div class="flex flex-col items-center justify-center space-y-4">
        <h1 class="text-xl font-bold text-teal-400">MIDI Player</h1>

        <!-- File Operations -->
        <div class="flex space-x-2 w-full justify-center">
            <button id="newBtn" class="btn text-sm">New</button>
            <label for="midiFile" class="btn cursor-pointer text-sm">Open</label>
            <input type="file" id="midiFile" accept=".mid,.midi" class="hidden">
            <button id="saveBtn" class="btn text-sm" disabled title="Save not supported">Save</button>
            <button id="saveAsBtn" class="btn text-sm" disabled title="Save As not supported">Save As</button>
        </div>

        <div id="fileInfo" class="w-full text-center text-gray-300 hidden">
            <span class="text-sm font-medium" id="fileName"></span>
        </div>

        <!-- Progress Bar -->
        <div class="w-full flex items-center space-x-2">
            <span id="currentTimeDisplay" class="text-xs text-gray-400">0:00</span>
            <input type="range" id="progressBar" min="0" max="100" value="0" step="0.1" disabled>
            <span id="durationDisplay" class="text-xs text-gray-400">0:00</span>
        </div>

        <!-- Player Controls -->
        <div class="flex items-center space-x-2">
            <button id="rewindBtn" class="btn emoji-btn" disabled title="Rewind to start">⏪</button>
            <button id="playPauseBtn" class="btn emoji-btn" disabled title="Play / Pause">
                <span id="playIcon">▶️</span>
                <span id="pauseIcon" class="hidden">⏸️</span>
            </button>
            <button id="ejectBtn" class="btn emoji-btn" disabled title="Stop and remove file">⏏️</button>
        </div>
        
        <div id="statusMessage" class="mt-4 text-center text-sm font-medium"></div>

        <!-- Custom Modal/Message Box -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full">
                <p id="modalMessage" class="text-center text-white mb-4"></p>
                <button id="modalClose" class="w-full px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-semibold rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <script>
        const newBtn = document.getElementById('newBtn');
        const fileInput = document.getElementById('midiFile');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const rewindBtn = document.getElementById('rewindBtn');
        const ejectBtn = document.getElementById('ejectBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileNameSpan = document.getElementById('fileName');
        const statusMessage = document.getElementById('statusMessage');
        const progressBar = document.getElementById('progressBar');
        const currentTimeDisplay = document.getElementById('currentTimeDisplay');
        const durationDisplay = document.getElementById('durationDisplay');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const modalClose = document.getElementById('modalClose');

        let player;
        let audioContext;
        let midiFile;
        let currentPlayEvent;
        let playInterval;

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Custom modal function to replace alert()
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        modalClose.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        function setPlayerState(isPlaying) {
            if (isPlaying) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            } else {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            }
        }

        function enablePlayerControls() {
            playPauseBtn.disabled = false;
            rewindBtn.disabled = false;
            ejectBtn.disabled = false;
            progressBar.disabled = false;
        }

        function disablePlayerControls() {
            playPauseBtn.disabled = true;
            rewindBtn.disabled = true;
            ejectBtn.disabled = true;
            progressBar.disabled = true;
        }

        function resetPlayer() {
            player.cancelQueue();
            clearInterval(playInterval);
            setPlayerState(false);
            progressBar.value = 0;
            currentTimeDisplay.textContent = '0:00';
            durationDisplay.textContent = '0:00';
            midiFile = null;
            currentPlayEvent = null;
        }

        function updateProgressBar() {
            if (currentPlayEvent && audioContext) {
                const elapsed = audioContext.currentTime - currentPlayEvent.start;
                const progress = (elapsed / currentPlayEvent.duration) * 100;
                progressBar.value = Math.min(100, Math.max(0, progress));
                currentTimeDisplay.textContent = formatTime(elapsed);
                if (elapsed >= currentPlayEvent.duration) {
                    resetPlayer();
                    statusMessage.textContent = "Playback finished.";
                }
            }
        }

        // Initialize the player and audio context on window load
        window.onload = function() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                player = new WebAudioFontPlayer();
                player.initAudioContext(audioContext);
                player.adjustPreset(audioContext, player.loader.zone[1]);
                statusMessage.textContent = "Ready to load a MIDI file.";
                // Start a background interval to update the progress bar, even if not playing
                playInterval = setInterval(updateProgressBar, 100);
            } catch (e) {
                showModal("Web Audio API is not supported in this browser.");
                statusMessage.textContent = "Error: Web Audio API not supported.";
            }
        };

        // Handle file selection
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                fileNameSpan.textContent = file.name;
                fileInfo.classList.remove('hidden');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        midiFile = MidiParser.parse(arrayBuffer);
                        currentPlayEvent = player.prepareMidiFile(midiFile);
                        if (currentPlayEvent) {
                            durationDisplay.textContent = formatTime(currentPlayEvent.duration);
                            enablePlayerControls();
                            statusMessage.textContent = "File loaded. Press play.";
                        } else {
                            showModal("Could not prepare MIDI file for playback.");
                            disablePlayerControls();
                        }
                    } catch (err) {
                        showModal("Failed to parse MIDI file. Please check the file format.");
                        disablePlayerControls();
                        midiFile = null;
                        console.error("MIDI parsing error:", err);
                    }
                };
                reader.onerror = function(e) {
                    showModal("Failed to read file.");
                    disablePlayerControls();
                };
                reader.readAsArrayBuffer(file);
            } else {
                fileInfo.classList.add('hidden');
                disablePlayerControls();
            }
        });

        // Toggle Play/Pause
        playPauseBtn.addEventListener('click', () => {
            if (!midiFile) {
                showModal("Please load a MIDI file first.");
                return;
            }
            if (playIcon.classList.contains('hidden')) {
                // Currently playing, so pause
                player.cancelQueue();
                setPlayerState(false);
                statusMessage.textContent = "Paused.";
            } else {
                // Currently paused, so play
                player.cancelQueue();
                currentPlayEvent = player.prepareMidiFile(midiFile);
                if (currentPlayEvent) {
                    player.startPlay(currentPlayEvent, player.loader.zone[1]);
                    setPlayerState(true);
                    statusMessage.textContent = "Playing...";
                } else {
                    showModal("Could not prepare MIDI file for playback.");
                }
            }
        });

        // Rewind button
        rewindBtn.addEventListener('click', () => {
            if (midiFile) {
                player.cancelQueue();
                setPlayerState(false);
                progressBar.value = 0;
                currentTimeDisplay.textContent = '0:00';
                statusMessage.textContent = "Rewound to start.";
            }
        });

        // Eject/Stop button
        ejectBtn.addEventListener('click', () => {
            if (midiFile) {
                fileInfo.classList.add('hidden');
                disablePlayerControls();
                resetPlayer();
                statusMessage.textContent = "File stopped and removed.";
            }
        });

        // New File button
        newBtn.addEventListener('click', () => {
            fileInput.value = '';
            fileInfo.classList.add('hidden');
            disablePlayerControls();
            resetPlayer();
            statusMessage.textContent = "Ready to load a new MIDI file.";
        });
    </script>
</body>
</html>
